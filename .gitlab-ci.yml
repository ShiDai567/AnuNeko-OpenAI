stages:
  - build
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  # 自动适配任何仓库名
  IMAGE_NAME: $CI_REGISTRY_IMAGE

.extract_version: &extract_version
  - |
    if [ "$CI_COMMIT_TAG" ]; then
      VERSION=${CI_COMMIT_TAG#v}
    else
      VERSION=$CI_COMMIT_SHORT_SHA
    fi
    echo "VERSION=$VERSION" > version.env
    echo "目标镜像路径: $IMAGE_NAME:$VERSION"

build_image:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    # 自动登录，确保使用 CI 提供的临时权限
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - *extract_version
    - source version.env
  script:
    - |
      # 构建镜像，同时标记两个标签
      docker build -t $IMAGE_NAME:$VERSION -t $IMAGE_NAME:latest -f ./docker/Dockerfile .
      
      # 分别推送
      docker push $IMAGE_NAME:$VERSION
      docker push $IMAGE_NAME:latest
  artifacts:
    reports:
      dotenv: version.env
  only:
    - main
    - master
    - tags

create_release:
  stage: release
  image: alpine:latest
  needs:
    - job: build_image
      artifacts: true
  before_script:
    - apk add --no-cache curl jq git
  script:
    - |
      if [ -z "$CI_COMMIT_TAG" ]; then exit 0; fi
      
      # 自动获取 CHANGELOG
      PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      [ -n "$PREV_TAG" ] && CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD) || CHANGELOG="Initial release"

      # 安全构造 JSON
      JSON_DATA=$(jq -n \
        --arg n "Release $VERSION" \
        --arg t "$CI_COMMIT_TAG" \
        --arg d "### Docker Pull命令:\n\`docker pull $IMAGE_NAME:$VERSION\`\n\n### 变更日志:\n$CHANGELOG" \
        '{name: $n, tag_name: $t, description: $d}')

      curl --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "$JSON_DATA" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  when: manual