# 精简后的 GitLab CI/CD 配置文件
stages:
  - build
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"
  IMAGE_NAME: $CI_REGISTRY_IMAGE

# 提取版本信息的参考块
.extract_version: &extract_version
  - |
    # 初始化环境变量文件
    echo "VERSION=latest" > version.env
    if [ "$CI_COMMIT_TAG" ]; then
      # 提取版本号 (v1.0 -> 1.0)
      VERSION=${CI_COMMIT_TAG#v}
      echo "VERSION=$VERSION" > version.env
      echo "当前版本: $VERSION"
    else
      echo "非标签推送，使用 Commit SHA 作为临时版本"
      VERSION=$CI_COMMIT_SHORT_SHA
      echo "VERSION=$VERSION" > version.env
    fi

# 阶段 1: 构建并推送镜像
build_image:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - *extract_version
    - source version.env
  script:
    - |
      echo "步骤 1: 清理远程旧镜像标签 (针对 $VERSION 和 latest)"
      # 使用 buildx imagetools rm 尝试删除远程仓库中的旧标签，防止残留
      docker buildx imagetools rm $IMAGE_NAME:$VERSION || true
      docker buildx imagetools rm $IMAGE_NAME:latest || true

      echo "步骤 2: 构建新镜像"
      docker build -t $IMAGE_NAME:$VERSION -f ./docker/Dockerfile .

      echo "步骤 3: 标记 latest 并推送"
      docker tag $IMAGE_NAME:$VERSION $IMAGE_NAME:latest
      
      docker push $IMAGE_NAME:$VERSION
      docker push $IMAGE_NAME:latest
  artifacts:
    reports:
      dotenv: version.env
  only:
    - main
    - master
    - tags

# 阶段 2: 创建 Release (仅限 Tag 推送)
create_release:
  stage: release
  image: alpine:latest
  needs:
    - job: build_image
      artifacts: true
  before_script:
    - apk add --no-cache curl jq git
  script:
    - |
      if [ -z "$CI_COMMIT_TAG" ]; then echo "非标签推送，跳过"; exit 0; fi
      
      echo "正在为 $VERSION 创建 Release..."
      
      # 生成简易变更日志
      PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      if [ -n "$PREV_TAG" ]; then
        CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD)
      else
        CHANGELOG="首次发布"
      fi

      # 构造 Release 描述
      RELEASE_BODY="## 版本 $VERSION\n\n### Docker 镜像\n- \`docker pull $IMAGE_NAME:$VERSION\`\n- \`docker pull $IMAGE_NAME:latest\`\n\n### 变更日志\n$CHANGELOG"

      # 调用 GitLab API
      curl --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "{\"name\":\"Release $VERSION\",\"description\":\"$RELEASE_BODY\",\"tag_name\":\"$CI_COMMIT_TAG\"}" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  when: manual