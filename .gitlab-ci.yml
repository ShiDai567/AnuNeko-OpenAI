stages:
  - build
  - release

variables:
  DOCKER_DRIVER: overlay2
  DOCKER_TLS_CERTDIR: "/certs"

.extract_version: &extract_version
  - |
    # 1. 提取版本
    if [ "$CI_COMMIT_TAG" ]; then
      VERSION=${CI_COMMIT_TAG#v}
    else
      VERSION=$CI_COMMIT_SHORT_SHA
    fi
    echo "VERSION=$VERSION" > version.env
    
    # 2. 强制将路径转为全小写 (解决 404 的关键)
    # 例如：ShiDai/AnuNeko -> shidai/anuneko
    LOWER_IMAGE_NAME=$(echo "$CI_REGISTRY_IMAGE" | tr '[:upper:]' '[:lower:]')
    echo "IMAGE_NAME=$LOWER_IMAGE_NAME" >> version.env
    
    echo "确定推送路径: $LOWER_IMAGE_NAME"

build_image:
  stage: build
  image: docker:24.0.5
  services:
    - docker:24.0.5-dind
  before_script:
    # 使用 CI 自动生成的令牌登录
    - echo $CI_REGISTRY_PASSWORD | docker login -u $CI_REGISTRY_USER --password-stdin $CI_REGISTRY
    - *extract_version
    - source version.env
  script:
    - |
      # 此时 $IMAGE_NAME 已经是小写了
      echo "步骤 1: 构建镜像"
      docker build -t $IMAGE_NAME:$VERSION -t $IMAGE_NAME:latest -f ./docker/Dockerfile .
      
      echo "步骤 2: 推送镜像"
      docker push $IMAGE_NAME:$VERSION
      docker push $IMAGE_NAME:latest
  artifacts:
    reports:
      dotenv: version.env
  only:
    - main
    - master
    - tags

create_release:
  stage: release
  image: alpine:latest
  needs:
    - job: build_image
      artifacts: true
  before_script:
    - apk add --no-cache curl jq git
  script:
    - |
      source version.env
      if [ -z "$CI_COMMIT_TAG" ]; then echo "非标签，不创建 Release"; exit 0; fi
      
      # 生成简易变更日志
      PREV_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
      [ -n "$PREV_TAG" ] && CHANGELOG=$(git log --pretty=format:"- %s (%h)" $PREV_TAG..HEAD) || CHANGELOG="Initial release"

      # 构造 JSON
      JSON_DATA=$(jq -n \
        --arg n "Release $VERSION" \
        --arg t "$CI_COMMIT_TAG" \
        --arg d "### 快速下载\n\`docker pull $IMAGE_NAME:$VERSION\`\n\n### 变更日志\n$CHANGELOG" \
        '{name: $n, tag_name: $t, description: $d}')

      curl --request POST \
        --header "PRIVATE-TOKEN: $GITLAB_TOKEN" \
        --header "Content-Type: application/json" \
        --data "$JSON_DATA" \
        "$CI_API_V4_URL/projects/$CI_PROJECT_ID/releases"
  only:
    - tags
  when: manual