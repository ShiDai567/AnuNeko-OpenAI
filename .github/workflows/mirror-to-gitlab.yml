name: Mirror to GitLab

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]
  workflow_dispatch:  # 允许手动触发

jobs:
  mirror:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout GitHub repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # 获取完整的提交历史

    - name: Configure Git
      run: |
        git config --global user.name "GitHub Actions"
        git config --global user.email "actions@github.com"

    - name: Add GitLab remote
      env:
        GITLAB_URL: ${{ secrets.GITLAB_URL }}
        GITLAB_REPO: ${{ secrets.GITLAB_REPO }}
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
      run: |
        # 检查必要的secret是否已设置
        if [ -z "$GITLAB_URL" ] || [ -z "$GITLAB_REPO" ] || [ -z "$GITLAB_TOKEN" ]; then
          echo "错误: 请设置GITLAB_URL, GITLAB_REPO和GITLAB_TOKEN secrets"
          exit 1
        fi
        
        # 添加GitLab远程仓库
        git remote add gitlab "https://oauth2:${GITLAB_TOKEN}@${GITLAB_URL}/${GITLAB_REPO}.git"
        
        # 验证连接
        git ls-remote gitlab > /dev/null
        if [ $? -ne 0 ]; then
          echo "错误: 无法连接到GitLab仓库，请检查URL和Token"
          exit 1
        fi

    - name: Push to GitLab
      env:
        GITHUB_REF: ${{ github.ref }}
      run: |
        # 获取当前分支名
        CURRENT_BRANCH=$(echo $GITHUB_REF | sed 's/refs\/heads\///')
        
        # 如果是PR，获取目标分支
        if [ "${{ github.event_name }}" == "pull_request" ]; then
          CURRENT_BRANCH="${{ github.head_ref }}"
        fi
        
        # 推送到GitLab
        echo "正在推送分支: $CURRENT_BRANCH"
        git push gitlab $CURRENT_BRANCH
        
        # 如果是main/master分支，也推送标签
        if [ "$CURRENT_BRANCH" == "main" ] || [ "$CURRENT_BRANCH" == "master" ]; then
          echo "推送所有标签到GitLab"
          git push gitlab --tags
        fi

    - name: Create GitLab MR (if not main/master)
      if: github.ref != 'refs/heads/main' && github.ref != 'refs/heads/master' && github.event_name == 'push'
      env:
        GITLAB_URL: ${{ secrets.GITLAB_URL }}
        GITLAB_REPO: ${{ secrets.GITLAB_REPO }}
        GITLAB_TOKEN: ${{ secrets.GITLAB_TOKEN }}
        GITHUB_REF: ${{ github.ref }}
      run: |
        # 获取当前分支名
        CURRENT_BRANCH=$(echo $GITHUB_REF | sed 's/refs\/heads\///')
        
        # 检查是否已存在MR
        MR_EXISTS=$(curl --silent --request GET \
          --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
          "${GITLAB_URL}/api/v4/projects/$(echo ${GITLAB_REPO} | sed 's/\//%2F/g')/merge_requests?source_branch=${CURRENT_BRANCH}" | \
          jq '. | length')
        
        if [ "$MR_EXISTS" == "0" ]; then
          echo "创建GitLab合并请求..."
          curl --request POST \
            --header "PRIVATE-TOKEN: ${GITLAB_TOKEN}" \
            --header "Content-Type: application/json" \
            --data "{
              \"source_branch\": \"${CURRENT_BRANCH}\",
              \"target_branch\": \"main\",
              \"title\": \"Mirror: ${CURRENT_BRANCH}\",
              \"description\": \"自动从GitHub镜像的分支: ${CURRENT_BRANCH}\n\n原始提交: ${{ github.sha }}\n提交者: ${{ github.actor }}\n\n---\n此MR由GitHub Actions自动创建\"
            }" \
            "${GITLAB_URL}/api/v4/projects/$(echo ${GITLAB_REPO} | sed 's/\//%2F/g')/merge_requests"
        else
          echo "合并请求已存在，跳过创建"
        fi